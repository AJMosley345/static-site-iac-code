---
- name: Create directories for site and repository
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ git_username }}"
    group: "{{ git_username }}"
    mode: '0755'
  loop:
    - "{{ git_www_path }}"

- name: Sets git default branch to be main instead of master  # noqa: command-instead-of-module # Suppresses lint rule about using command module when a module is available
  ansible.builtin.command:
    cmd: git config --global init.defaultBranch main

- name: Initialize bare Git repository  # noqa: command-instead-of-module # Suppresses lint rule about using command module when a module is available
  ansible.builtin.command:
    cmd: git init --bare {{ git_repo_path }}
  args:
    creates: "{{ git_repo_path }}"

- name: Set ownership of the Git repository
  ansible.builtin.file:
    path: "{{ git_repo_path }}"
    state: directory
    recurse: true
    owner: "{{ git_username }}"
    group: "{{ git_username }}"
    mode: '0755'

- name: Add Git post-receive hook
  ansible.builtin.copy:
    dest: "{{ git_repo_path }}/hooks/post-receive"
    content: |
      #!/bin/bash
      set -e

      # Define repo and website paths
      GIT_REPO="{{ git_repo_path }}"
      WORK_TREE="{{ git_www_path }}"

      # Checkout the latest code
      cd $GIT_REPO
      GIT_WORK_TREE=$WORK_TREE git checkout -f

      # Install dependencies and build
      cd $WORK_TREE
      yarn install --production
      yarn build
    mode: '0755'
    owner: "{{ git_username }}"
    group: "{{ git_username }}"
